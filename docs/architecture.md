# 架构概述
Agent Zero 构建在一个灵活且模块化的架构上，专为可扩展性和可定制性而设计。本节概述了关键组件及其之间的交互。

## 系统架构
这个简化图说明了代理之间的层次关系，以及它们与工具、扩展、工具集、提示、记忆和知识库的交互。

![Agent Zero 架构](res/arch-01.svg)

用户或 Agent 0 位于层次结构的顶部，将任务委派给下属代理，这些代理可以进一步委派给其他代理。每个代理都可以利用工具并访问共享资源（提示、记忆、知识、扩展和工具集）来执行其任务。

## 运行时架构
Agent Zero 的运行时架构围绕 Docker 容器构建：

1. **主机系统（您的机器）**：
- 仅需要 Docker 和网页浏览器
- 运行 Docker Desktop 或 Docker Engine
- 处理容器编排

2. **运行时容器**：
- 包含完整的 Agent Zero 框架
- 管理 Web UI 和 API 端点
- 处理所有核心功能，包括代码执行
- 在所有平台上提供标准化环境

这种架构确保：
- 跨平台环境一致性
- 简化的部署和更新
- 通过容器化增强安全性
- 减少主机系统的依赖要求
- 为高级用户提供灵活的部署选项

> [!NOTE]
> 在主机系统上直接运行 Agent Zero 的传统方法（使用 Python、Conda 等）
> 仍然可行，但需要通过设置页面配置远程函数调用（RFC）。
> 有关详细说明，请参见[完整二进制安装](installation.md#in-depth-guide-for-full-binaries-installation)。

## 实现细节

### 目录结构
| 目录 | 描述 |
| --- | --- |
| `/docker` | 运行时容器的 Docker 相关文件 |
| `/docs` | 文档文件和指南 |
| `/instruments` | 运行时环境的自定义脚本和工具 |
| `/knowledge` | 知识库存储 |
| `/logs` | HTML CLI 风格的聊天日志 |
| `/memory` | 持久代理记忆存储 |
| `/prompts` | 系统和工具提示 |
| `/python` | 核心 Python 代码库： |
| `/api` | API 端点和接口 |
| `/extensions` | 模块化扩展 |
| `/helpers` | 实用函数 |
| `/tools` | 工具实现 |
| `/tmp` | 临时运行时数据 |
| `/webui` | Web 界面组件： |
| `/css` | 样式表 |
| `/js` | JavaScript 模块 |
| `/public` | 静态资源 |
| `/work_dir` | 工作目录 |

### 关键文件
| 文件 | 描述 |
| --- | --- |
| `.env` | 环境配置 |
| `agent.py` | 核心代理实现 |
| `example.env` | 配置模板 |
| `initialize.py` | 框架初始化 |
| `models.py` | 模型提供商和配置 |
| `preload.py` | 预初始化例程 |
| `prepare.py` | 环境准备 |
| `requirements.txt` | Python 依赖 |
| `run_cli.py` | CLI 启动器 |
| `run_ui.py` | Web UI 启动器 |

> [!NOTE]
> 使用 Docker 运行时容器时，这些目录被挂载在 `/a0` 卷中，
> 以保持数据持久性，直到容器重启或删除。

## 核心组件
Agent Zero 的架构围绕以下关键组件：

### 1. 代理
框架中的核心执行者。代理接收指令、推理、做出决策，并利用工具来实现其目标。代理在层次结构中运行，上级代理将任务委派给下属代理。

#### 代理层次结构和通信
Agent Zero 采用层次代理结构，顶级代理（通常是用户）可以将任务委派给下属代理。这种层次结构允许将复杂任务高效地分解为更小、更易管理的子任务。

代理之间通过消息进行通信，这些消息根据提示模板进行结构化。这些消息通常包括：

| 参数 | 描述 |
| --- | --- |
| `Thoughts:` | 代理的思维链和规划过程 |
| `Tool name:` | 代理使用的特定工具 |
| `Responses or queries:` | 来自工具或其他代理的结果、反馈或查询 |

#### 交互流程
Agent Zero 中的典型交互流程可能如下所示：

![交互流程](res/flow-01.svg)

1. 用户向 Agent 0 提供指令
2. Agent 0 初始化 VectorDB 并访问记忆
3. Agent 0 分析指令并使用 `thoughts` 参数制定计划，可能涉及使用工具或创建子代理
4. 如有必要，Agent 0 将子任务委派给下属代理
5. 代理使用工具执行操作，同时提供参数和响应或查询
6. 代理将结果和反馈向上级层次报告
7. Agent 0 向用户提供最终响应

### 2. 工具
工具是代理可以利用的功能。这些可以包括从网络搜索和代码执行到与 API 交互或控制外部软件的任何内容。Agent Zero 提供了定义和集成内置和自定义工具的机制。

#### 内置工具
Agent Zero 配备了一套内置工具，旨在帮助代理高效执行任务：

| 工具 | 功能 |
| --- | --- |
| behavior_adjustment | Agent Zero 使用此工具根据用户之前的请求改变其行为 |
| call_subordinate | 允许代理将任务委派给下属代理 |
| code_execution_tool | 允许代理在终端中执行 Python、Node.js 和 Shell 代码 |
| input | 允许代理使用键盘与活动 shell 交互 |
| knowledge_tool | 使代理能够从记忆、知识库或在线外部源检索信息 |
| response_tool | 允许代理输出响应 |
| memory_tool | 使代理能够保存、加载、删除和遗忘记忆中的信息 |
| webpage_content_tool | 使代理能够获取和分析网页的文本内容 |

#### 知识工具
`knowledge_tool` 使用 SearXNG 搜索网络并检索信息。它还可以搜索本地知识库和记忆以获取相关信息。该工具返回信息的摘要，代理可以用它来做出决策或回答问题。

#### SearXNG 集成
Agent Zero 已将 SearXNG 集成为其主要搜索工具，取代了以前的知识工具（Perplexity 和 DuckDuckGo）。这种集成增强了代理检索信息的能力，同时确保用户隐私和定制。

- 注重隐私的搜索
SearXNG 是一个开源元搜索引擎，允许用户搜索多个来源而不跟踪其查询。这种集成确保用户数据在访问广泛信息时保持私密和安全。

- 增强的搜索能力
该集成提供对各种类型内容的访问，包括图像、视频和新闻文章，允许用户收集任何主题的全面信息。

- 回退机制
在 SearXNG 可能无法返回满意结果的情况下，Agent Zero 可以配置为回退到其他来源或方法，确保用户始终能够访问信息。

> [!NOTE]
> 知识工具设计为与通过 SearXNG 的在线搜索和本地知识库查询无缝协作，
> 提供全面的信息检索系统。

#### 自定义工具
用户可以创建自定义工具来扩展 Agent Zero 的功能。自定义工具可以通过定义工具规范集成到框架中，包括要放置在 `/prompts/$FOLDERNAME/agent.system.tool.$TOOLNAME.md` 中的工具提示，如下所述。

1. 在 `prompts/$SUBDIR` 中创建 `agent.system.tool.$TOOL_NAME.md`
2. 在 `agent.system.tools.md` 中添加引用
3. 如果需要，在 `python/tools` 中使用 `Tool` 基类实现工具类
4. 遵循现有模式以保持一致性

> [!NOTE]
> 工具始终存在于系统提示中，因此应将其保持在最低限度。
> 为了节省一些 token，使用[工具集模块](#adding-instruments)
> 来调用自定义脚本或函数。

### 3. 记忆系统
记忆系统是 Agent Zero 的关键组件，使代理能够从过去的交互中学习和适应。它在混合模型上运行，其中部分记忆由框架自动管理，而用户也可以手动输入和提取信息。

#### 记忆结构
记忆分为四个不同的区域：
- **存储和检索**用户提供的信息（例如，名称、API 密钥）
- **片段**：包含来自先前对话的信息片段，自动更新
- **解决方案**：存储来自过去交互的成功解决方案以供将来参考
- **元数据**：每个记忆条目包括元数据（ID、时间戳），支持基于特定条件的高效过滤和搜索

#### 消息历史和总结

Agent Zero 采用复杂的消息历史和总结系统，以有效维护上下文，同时优化内存使用。该系统动态管理信息流，确保相关细节随时可用，同时高效处理上下文窗口的限制。

- **上下文提取：** 系统从先前的消息中识别对正在进行的讨论至关重要的关键信息。这个过程反映了人类如何回忆重要记忆，允许不太重要的细节逐渐淡出。
- **总结过程：** 通过实用模型使用自然语言处理，Agent Zero 将提取的信息压缩为简洁的摘要。通过总结过去的交互，Agent Zero 可以快速回忆整个聊天的重要事实，从而提供更适当的响应。
- **上下文相关性：** 根据与当前主题的相关性对总结的上下文进行优先排序，确保用户收到最相关的信息。

**实现细节：**

- **消息摘要：** 使用结构化格式对单个消息进行摘要，捕获关键信息同时减少 token 使用。
- **动态压缩：** 系统采用智能压缩策略：
  - 最近的消息保持原始形式以提供即时上下文。
  - 较旧的消息逐渐压缩为更简洁的摘要。
  - 多个压缩级别允许高效使用上下文窗口。
  - 原始消息与摘要分开保存。
- **上下文窗口优化：**
  - 作为单个对话的近无限短期记忆。
  - 根据可用空间和设置动态调整压缩比率。
- **批量主题总结：**
  - 将相关消息分组为主题块以更好地组织。
  - 生成多个消息的简洁摘要，同时保留关键上下文。
  - 实现长对话历史的高效导航。
  - 维护相关主题之间的语义连接。

通过动态调整上下文窗口和总结过去的交互，Agent Zero 提高了效率和用户体验。这种创新不仅反映了框架对动态和以用户为中心的承诺，还从人类认知过程中汲取灵感，使 AI 交互更加相关和有效。就像人类会忘记琐碎的细节一样，Agent Zero 智能地压缩信息以增强沟通。

> [!NOTE]
> 为了最大化上下文总结的有效性，用户应在交互过程中提供清晰和具体的指令。
> 这有助于 Agent Zero 理解哪些细节最重要需要保留。

### 4. 提示
`prompts` 目录包含控制代理行为和通信的各种 Markdown 文件。最重要的文件是 `agent.system.main.md`，它作为中央枢纽，引用其他提示文件。

#### 核心提示文件
| 提示文件 | 描述 |
|---|---|
| agent.system.main.role.md | 定义代理的整体角色和能力 |
| agent.system.main.communication.md | 指定代理应如何通信 |
| agent.system.main.solving.md | 描述代理处理任务的方法 |
| agent.system.main.tips.md | 提供额外的提示或指导 |
| agent.system.main.behaviour.md | 控制动态行为调整和规则 |
| agent.system.main.environment.md | 定义运行时环境上下文 |
| agent.system.tools.md | 组织和调用各个工具提示文件 |
| agent.system.tool.*.md | 各个工具提示文件 |

#### 提示组织
- **默认提示：** 位于 `prompts/default/`，作为基本配置
- **自定义提示：** 可以放在自定义子目录中（例如，`prompts/my-custom/`）
- **行为文件：** 作为 `behaviour.md` 存储在记忆中，包含动态规则
- **工具提示：** 在工具特定文件中组织，以实现模块化

#### 自定义提示
1. 在 `prompts/` 中创建目录（例如，`my-custom-prompts`）
2. 从 `prompts/default/` 复制并修改所需文件
3. Agent Zero 将合并您的自定义文件与默认文件
4. 在设置页面（代理配置部分）选择您的自定义提示

#### 动态行为系统
- **行为调整：**
  - 代理可以根据用户指令实时修改其行为
  - 行为更改自动集成到系统提示中
  - 行为规则智能合并，避免重复和冲突

- **行为管理组件：**
  - `behaviour_adjustment.py`：更新代理行为的核心工具
  - `_20_behaviour_prompt.py`：将行为规则注入系统提示的扩展
  - 自定义规则作为 `behaviour.md` 存储在代理的记忆目录中

- **行为更新过程：**
  1. 用户请求行为更改（例如，"用英式英语回复"）
  2. 系统在对话中识别行为指令
  3. 新规则与现有规则集合并
  4. 更新的行为立即应用

![行为调整](res/ui-behavior-change-chat.png)

- **与系统提示的集成：**
  - 行为规则在系统提示开始时注入
  - 规则以结构化的 markdown 格式格式化
  - 更改在不破坏其他组件的情况下应用
  - 保持核心功能和行为规则之间的分离

> [!NOTE]  
> 您可以自定义这些文件中的任何一个。如果您的自定义 `prompts_subdir` 中存在文件，
> Agent Zero 将使用这些文件，否则将回退到 `prompts/default` 中的文件。

> [!TIP]
> 行为系统允许动态调整，而无需修改基本提示文件。
> 通过行为规则进行的更改在会话之间保持，同时保持核心功能。

### 5. 知识
知识是指代理可以利用的用户提供的信息和数据：

- **自定义知识：** 通过 UI 中的"导入知识"按钮手动或自动将文件添加到 `/knowledge/custom/main` 目录
  - 支持的格式：`.txt`、`.pdf`、`.csv`、`.html`、`.json`、`.md`
  - 自动导入和索引
  - 可扩展的格式支持

- **知识库：**
  - 可以包括 PDF、数据库、书籍、文档
  - 自动添加 `/docs` 文件夹
  - 用于回答问题和决策
  - 支持 RAG 增强任务

### 6. 工具集
工具集提供了一种向 Agent Zero 添加自定义功能的方法，而不会增加系统提示的 token 数量：
- 存储在 Agent Zero 的长期记忆中
- 可用的工具集数量不限
- 在代理需要时调用
- 可以通过引入新程序修改代理行为
- 函数调用或脚本以与其他系统集成
- 脚本在 Docker 容器内运行

#### 添加工具集
1. 在 `instruments/custom` 中创建文件夹（名称中不含空格）
2. 添加 `.md` 描述文件作为接口
3. 添加 `.sh` 脚本（或其他可执行文件）作为实现
4. 代理将自动检测并使用该工具集

### 7. 扩展
扩展是 Agent Zero 的强大功能，旨在保持主代码库的整洁和组织，同时允许更大的灵活性和模块化。

#### 结构
扩展可以在 `python/extensions` 目录中找到：
- **文件夹组织：** 扩展存储在指定的子文件夹中，对应于代理消息循环的不同方面
- **执行顺序：** 文件按字母顺序执行，以实现可预测的行为
- **命名约定：** 文件以数字开头以控制执行顺序
- **模块化：** 每个扩展专注于特定功能

#### 类型
- **消息循环提示：** 处理系统消息和历史构建
- **记忆管理：** 处理回忆和解决方案记忆
- **系统集成：** 管理与外部系统的交互

#### 添加扩展
1. 在适当的 `python/extensions` 子文件夹中创建 Python 文件
2. 遵循执行顺序的命名约定（以数字开头）
3. 按照现有模式实现功能
4. 确保与主系统兼容
5. 部署前彻底测试

> [!NOTE]  
> 考虑将有价值的自定义组件贡献给主仓库。
> 有关更多信息，请参见[贡献](contribution.md)。